<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <title>üí¨ Hybrid Encryption Chat</title>
    <script src="https://cdn.jsdelivr.net/npm/jsencrypt@3.3.2/bin/jsencrypt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
    <link rel="stylesheet" href="./style/stylekoe.css" />
</head>
<body>
<div class="container">
    <h1>üîê Hybrid Encryption Chat </h1><h1>(RSA + AES)</h1>
    <hr>
    <input id="username" placeholder="Nama Anda" />
    <button type="button" onclick="daftar()">Daftar (ganti kunci RSA)</button>
    <hr>
    <input id="recipient" placeholder="Kirim ke (nama penerima)" />
    <textarea id="message" placeholder="Tulis pesan..."></textarea>
    <button type="button" onclick="kirimPesan()">Kirim Pesan</button>
    <hr>
    <button type="button" onclick="lihatPesan()">Lihat Pesan Masuk</button>
    <pre id="chat-box"></pre>
</div>

<script>
    // 1Ô∏è‚É£ Registrasi dan buat pasangan kunci
    function daftar() {
        const nama = document.getElementById("username").value.trim();
        if (!nama) return alert("Masukkan nama Anda dulu!");

        const rsa = new JSEncrypt({ default_key_size: 1024 });
        rsa.getKey();

        const publicKey = rsa.getPublicKey();
        sessionStorage.setItem("privatekey", rsa.getPrivateKey());

        fetch("../backend/register.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username: nama, public_key: publicKey })
        })
            .then(r => r.text())
            .then(() => alert("‚úÖ Registrasi berhasil!"))
            .catch(() => alert("‚ùå Gagal registrasi."));
    }

    // 2Ô∏è‚É£ Kirim pesan terenkripsi (Hybrid AES + RSA)
    async function kirimPesan() {
        const pengirim = document.getElementById("username").value.trim();
        const penerima = document.getElementById("recipient").value.trim();
        const teks = document.getElementById("message").value.trim();

        if (!pengirim || !penerima || !teks) return alert("Isi semua kolom.");

        const r = await fetch(`../backend/ambil_public_key.php?username=${encodeURIComponent(penerima)}`);
        const data = await r.json();
        if (data.error) {
            alert("‚ùå Terjadi error: " + data.error);
            return;
        }
        if (!data.public_key) return alert("Public key penerima tidak ditemukan.");

        // üîê Enkripsi pesan dengan session key AES dan IV
        const sessionKey = CryptoJS.lib.WordArray.random(16);
        const iv = CryptoJS.lib.WordArray.random(16);
        const encrypted = CryptoJS.AES.encrypt(teks, sessionKey, { iv });
        const cipherText = iv.concat(encrypted.ciphertext).toString(CryptoJS.enc.Base64);

        // üîë Enkripsi session key dengan RSA
        const rsa = new JSEncrypt();
        rsa.setPublicKey(data.public_key);
        const encryptedSessionKey = rsa.encrypt(CryptoJS.enc.Base64.stringify(sessionKey));

        const payload = { asal: pengirim, tujuan: penerima, kunci: encryptedSessionKey, pesan: cipherText };

        await fetch("../backend/simpan_pesan.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        const now = new Date();
        const chatBox = document.getElementById("chat-box");
        chatBox.textContent += `[${now.toLocaleString('id-ID', {hour12: false})}] Aku ke ${penerima}: ${teks}\n`;
        chatBox.scrollTop = chatBox.scrollHeight;
        document.getElementById("message").value = "";
    }

    // 3Ô∏è‚É£ Lihat & dekripsi pesan
    async function lihatPesan() {
        const nama = document.getElementById("username").value.trim();
        const privateKey = sessionStorage.getItem("privatekey");
        if (!nama) return alert("Masukkan nama Anda dulu!");
        if (!privateKey) return alert("Private key tidak ada. Silakan daftar ulang.");

        const r = await fetch(`../backend/baca_pesan.php?username=${encodeURIComponent(nama)}`);
        const pesanMasuk = await r.json();

        const rsa = new JSEncrypt();
        rsa.setPrivateKey(privateKey);

        let hasil = "";
        for (const p of pesanMasuk) {
            try {
                // üîì Dekrip session key
                const sessionKeyBase64 = rsa.decrypt(p.kunci);
                if (!sessionKeyBase64) throw new Error("Gagal dekripsi kunci sesi");
                const sessionKey = CryptoJS.enc.Base64.parse(sessionKeyBase64);

                // üß© Pisahkan IV dan ciphertext dari pesan
                const data = CryptoJS.enc.Base64.parse(p.pesan);
                const iv = CryptoJS.lib.WordArray.create(data.words.slice(0, 4), 16);
                const ciphertext = CryptoJS.lib.WordArray.create(data.words.slice(4), data.sigBytes - 16);

                // ü™∂ Dekrip pesan AES
                const decrypted = CryptoJS.AES.decrypt({ ciphertext: ciphertext }, sessionKey, { iv });
                const plainText = decrypted.toString(CryptoJS.enc.Utf8);

                if (!plainText) throw new Error("Plaintext kosong");

                hasil += `[${p.timestamp}] Dari ${p.asal}: ${plainText}\n`;
            } catch (e) {
                hasil += `[${p.timestamp}] ‚ö†Ô∏è Gagal mendekripsi pesan: ${e.message}\n`;
            }
        }

        const chatBox = document.getElementById("chat-box");
        chatBox.textContent = hasil || "Belum ada pesan.\n";
        chatBox.scrollTop = chatBox.scrollHeight;
    }
</script>

</body>
</html>
