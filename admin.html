<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Luminous</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=PT+Serif:ital,wght@0,400;0,700;1,400&family=PT+Sans:wght@400;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <style>
        body {
            background-color: #f4f0e6;
            color: #3e2b1e;
            font-family: 'PT Sans', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: #2b1d12;
            color: #e6d2a0;
            display: flex;
            flex-direction: column;
            border-right: 2px solid #8c7348;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.3);
            z-index: 10;
        }

        .sidebar-header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid #5c4635;
            background: #1a110a;
        }

        .sidebar-header h2 {
            font-family: 'Cinzel', serif;
            margin: 0;
            font-size: 18px;
            color: #e6d2a0;
            letter-spacing: 1px;
        }

        .sidebar-nav {
            flex: 1;
            padding: 20px 0;
            overflow-y: auto;
        }

        .nav-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Cinzel', serif;
            font-size: 14px;
            border-left: 3px solid transparent;
            color: #b08d45;
        }

        .nav-item:hover {
            background: #3e2b1e;
            color: #fff;
        }

        .nav-item.active {
            background: #3e2b1e;
            border-left-color: #8c3333;
            color: #fff;
        }

        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid #5c4635;
            text-align: center;
            font-size: 12px;
            color: #8c7348;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: #f4f0e6;
        }

        .top-bar {
            background: #fffdf5;
            padding: 15px 30px;
            border-bottom: 1px solid #d4c5b0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .page-title {
            font-family: 'Cinzel', serif;
            font-size: 20px;
            color: #3e2b1e;
            margin: 0;
        }

        .content-area {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .access-denied-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            flex-direction: column;
            text-align: center;
            gap: 10px;
            padding: 20px;
            width: 100%;
            flex: 1;
        }

        .access-denied-body {
            display: block;
        }

        /* Data Table */
        .table-container {
            background: #fff;
            border: 1px solid #d4c5b0;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        th {
            background: #f0e6d2;
            color: #5c4635;
            font-family: 'Cinzel', serif;
            font-weight: bold;
            text-align: left;
            padding: 12px 15px;
            border-bottom: 2px solid #d4c5b0;
            white-space: nowrap;
        }

        td {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            color: #333;
            vertical-align: middle;
        }

        tr:hover {
            background: #fffdf5;
        }

        .action-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            font-family: 'Cinzel', serif;
            text-transform: uppercase;
            transition: background 0.2s;
        }

        .btn-delete {
            background: #8c3333;
            color: white;
        }

        .btn-delete:hover {
            background: #5e1e1e;
        }

        /* SQL Console */
        .sql-console {
            background: #2b1d12;
            padding: 20px;
            border-radius: 4px;
            margin-bottom: 20px;
            color: #e6d2a0;
        }

        .sql-input {
            width: 100%;
            background: #1a110a;
            border: 1px solid #5c4635;
            color: #00ff00;
            font-family: monospace;
            padding: 10px;
            font-size: 14px;
            resize: vertical;
            min-height: 80px;
            margin-bottom: 10px;
        }

        .btn-execute {
            background: #2e7d32;
            color: white;
            border: none;
            padding: 8px 20px;
            font-family: 'Cinzel', serif;
            cursor: pointer;
            border-radius: 3px;
        }

        .btn-execute:hover {
            background: #1b5e20;
        }

        /* Utils */
        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #8c7348;
            font-style: italic;
        }

        .error-msg {
            color: #8c3333;
            background: #ffebee;
            padding: 10px;
            border-radius: 3px;
            margin-bottom: 15px;
            border: 1px solid #ef9a9a;
        }

        .success-msg {
            color: #2e7d32;
            background: #e8f5e9;
            padding: 10px;
            border-radius: 3px;
            margin-bottom: 15px;
            border: 1px solid #a5d6a7;
        }

        /* Encryption Viz */
        .encryption-container {
            background: #fffdf5;
            border: 1px solid #d4c5b0;
            border-radius: 6px;
            padding: 30px;
            position: relative;
            overflow: hidden;
        }

        .viz-stage-container {
            display: grid;
            grid-template-columns: repeat(4, minmax(140px, 1fr));
            gap: 20px;
            position: relative;
            padding: 20px 20px 40px;
        }

        .viz-step {
            width: 100%;
            background: #fefaf2;
            border: 2px dashed #d4c5b0;
            border-radius: 8px;
            padding: 18px 12px;
            text-align: center;
            transition: transform 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
            min-height: 150px;
            position: relative;
        }

        .viz-stage-container .viz-step {
            width: 100%;
        }

        .viz-step.active-step {
            border-color: #8c3333;
            transform: translateY(-6px);
            box-shadow: 0 8px 20px rgba(140, 51, 51, 0.2);
        }

        .viz-step::after {
            content: '';
            position: absolute;
            top: 50%;
            right: -20px;
            width: 40px;
            height: 2px;
            background: #8c7348;
            transform: translateY(-50%);
        }

        .viz-step::before {
            content: '';
            position: absolute;
            top: 50%;
            right: -14px;
            border-width: 6px 0 6px 10px;
            border-style: solid;
            border-color: transparent transparent transparent #8c7348;
            transform: translate(100%, -50%);
        }

        .viz-stage-container .viz-step:last-child::after {
            display: none;
        }

        .viz-stage-container .viz-step:last-child::before {
            display: none;
        }

        .viz-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .viz-label {
            font-family: 'Cinzel', serif;
            font-size: 14px;
            text-transform: uppercase;
            color: #5c4635;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }

        .viz-box {
            border: 1px solid #d4c5b0;
            border-radius: 6px;
            padding: 10px;
            font-size: 13px;
            background: #fff;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .viz-packet {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: 2px solid #8c3333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            background: #fff;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
            z-index: 5;
        }

        .viz-controls {
            margin-top: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
        }

        .viz-field label {
            display: block;
            margin-bottom: 8px;
            font-size: 13px;
            color: #5c4635;
            font-weight: bold;
            font-family: 'Cinzel', serif;
        }

        .viz-field textarea {
            width: 100%;
            min-height: 80px;
            border-radius: 6px;
            border: 1px solid #d4c5b0;
            padding: 10px;
            resize: vertical;
            font-family: 'PT Sans', sans-serif;
        }

        .viz-info-box {
            background: #1a110a;
            color: #e6d2a0;
            font-family: monospace;
            border-radius: 6px;
            padding: 12px;
            min-height: 80px;
            border: 1px solid #5c4635;
            word-break: break-all;
        }

        .viz-info-box.light {
            background: #fff;
            border-color: #d4c5b0;
            color: #3e2b1e;
        }

        .viz-log {
            margin-top: 25px;
            background: #fff;
            border: 1px dashed #d4c5b0;
            border-radius: 6px;
            padding: 15px;
            min-height: 80px;
            font-size: 13px;
            color: #5c4635;
        }

        .viz-log strong {
            color: #8c3333;
        }

        .viz-description {
            text-align: center;
            color: #5c4635;
            font-size: 14px;
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .viz-buttons {
            margin-top: 30px;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
            justify-content: center;
        }

        .viz-buttons button {
            padding: 8px 16px;
            border-radius: 4px;
            border: 1px solid #8c7348;
            background: #fff;
            color: #3e2b1e;
            cursor: pointer;
            font-family: 'Cinzel', serif;
            text-transform: uppercase;
            font-size: 12px;
            transition: background 0.2s ease;
        }

        .viz-buttons button.primary {
            background: #2e7d32;
            color: #fff;
            border-color: #1b5e20;
        }

        .viz-buttons button:hover {
            background: #f0e6d2;
        }

        .viz-speed {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #5c4635;
            font-size: 12px;
            font-family: 'Cinzel', serif;
        }

        .viz-speed input[type="range"] {
            width: 160px;
        }

        .viz-info-grid {
            margin-top: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
        }

        .viz-info-card {
            background: #fff;
            border: 1px solid #d4c5b0;
            border-radius: 6px;
            padding: 15px;
            font-size: 13px;
            color: #3e2b1e;
        }

        .viz-info-card h4 {
            margin: 0 0 10px;
            font-family: 'Cinzel', serif;
            font-size: 15px;
            color: #8c3333;
        }

        .viz-info-card ul {
            padding-left: 18px;
            margin: 0;
            line-height: 1.5;
        }

        .about-section {
            background: #fffdf5;
            border: 1px solid #d4c5b0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .about-section h4 {
            margin-top: 0;
            font-family: 'Cinzel', serif;
            color: #8c3333;
        }

        .makers-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 10px;
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .makers-list li {
            background: rgba(255, 255, 255, 0.85);
            border: 1px dashed #d4c5b0;
            border-radius: 6px;
            padding: 10px 14px;
            font-weight: 600;
            color: #3e2b1e;
        }

        @media (max-width: 900px) {
            .viz-stage-container {
                grid-template-columns: repeat(2, minmax(160px, 1fr));
            }

            .viz-stage-container .viz-step::after,
            .viz-stage-container .viz-step::before {
                display: none;
            }
        }

        @media (max-width: 540px) {
            .viz-stage-container {
                grid-template-columns: 1fr;
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f4f0e6;
        }

        ::-webkit-scrollbar-thumb {
            background: #d4c5b0;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #8c7348;
        }
    </style>
</head>

<body>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>Admin Panel</h2>
        </div>
        <div class="sidebar-nav">
            <div class="nav-item" data-view="dashboard" onclick="switchTab('dashboard')">Dashboard</div>
            <div class="nav-item" onclick="switchTab('sql')">SQL Console</div>
            <div class="nav-item" onclick="switchTab('encryption')">Encryption Viz</div>
            <div class="nav-item" onclick="switchTab('about')">About</div>
            <div style="height: 20px;"></div>
            <div id="table-nav"></div>
        </div>
        <div class="sidebar-footer">
            <a href="index.html" style="color: #8c7348; text-decoration: none;">&larr; Back to Site</a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="top-bar">
            <h1 class="page-title" id="page-title">Tables</h1>
            <div id="user-info" style="font-size: 13px; color: #8c7348;">Checking access...</div>
        </div>

        <div class="content-area">
            <div id="message-area"></div>

            <!-- Dashboard View -->
            <div id="view-dashboard" class="card" style="padding:20px; margin-bottom:20px;">
                <h3 style="font-family:'Cinzel', serif; color:#3e2b1e; margin-top:0;">System Overview</h3>
                <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); margin-bottom:20px;">
                    <div class="stat-card">
                        <p class="stat-label">Total Users</p>
                        <p class="stat-value" id="dash-users">0</p>
                        <p class="muted" style="margin:0;">Priests: <span id="dash-priests">0</span> ‚Ä¢ Penitents: <span id="dash-penitents">0</span></p>
                    </div>
                    <div class="stat-card">
                        <p class="stat-label">Chat Threads</p>
                        <p class="stat-value" id="dash-threads">0</p>
                        <p class="muted" style="margin:0;">Open: <span id="dash-open-threads">0</span> ‚Ä¢ Closed: <span id="dash-closed-threads">0</span></p>
                    </div>
                    <div class="stat-card">
                        <p class="stat-label">Chat Messages</p>
                        <p class="stat-value" id="dash-messages">0</p>
                        <p class="muted" style="margin:0;">Last 24h: <span id="dash-messages-24h">0</span></p>
                    </div>
                    <div class="stat-card">
                        <p class="stat-label">Keys Registered</p>
                        <p class="stat-value" id="dash-keys">0</p>
                        <p class="muted" style="margin:0;">Missing Keys: <span id="dash-key-gaps">0</span></p>
                    </div>
                </div>
                <div id="dashboard-table" class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Metric</th>
                                <th>Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Most Active Priest</td>
                                <td id="dash-top-priest">-</td>
                            </tr>
                            <tr>
                                <td>Most Active Penitent</td>
                                <td id="dash-top-penitent">-</td>
                            </tr>
                            <tr>
                                <td>Latest Thread</td>
                                <td id="dash-latest-thread">-</td>
                            </tr>
                            <tr>
                                <td>Average Messages / Thread</td>
                                <td id="dash-avg-thread">0</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="table-container" style="margin-top:20px;">
                    <table>
                        <thead>
                            <tr>
                                <th>Environment</th>
                                <th>Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>PHP Version</td>
                                <td id="env-php">Loading...</td>
                            </tr>
                            <tr>
                                <td>MySQL Version</td>
                                <td id="env-mysql">Loading...</td>
                            </tr>
                            <tr>
                                <td>XAMPP Version</td>
                                <td id="env-xampp">N/A (manual)</td>
                            </tr>
                            <tr>
                                <td>Server Software</td>
                                <td id="env-server">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="about-section" style="margin-top:20px;">
                    <h4>Test & Diagnostics</h4>
                    <p style="line-height:1.6; color:#5c4635;">Jalankan pengujian cepat untuk memastikan seluruh modul masih berjalan baik. Hasil dieksekusi langsung di server dan ditampilkan di bawah ini.</p>
                    <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:15px;">
                        <button class="btn-execute" onclick="runTest('workflow')">Workflow Smoke</button>
                        <button class="btn-execute" style="background:#5c4635;" onclick="runTest('db')">Database Check</button>
                        <button class="btn-execute" style="background:#3e2b1e;" onclick="runTest('integrity')">Integrity Probe</button>
                    </div>
                    <pre id="test-output" style="background:#1a110a; color:#e6d2a0; padding:15px; border-radius:6px; min-height:120px; overflow-x:auto; font-size:12px;">Klik salah satu tombol untuk menjalankan tes.</pre>
                </div>
            </div>

            <!-- Tables View -->
            <div id="view-tables">
                <div class="table-container">
                    <div id="data-table-wrapper">
                        <div class="loading">Select a table from the sidebar to view data.</div>
                    </div>
                </div>
            </div>

            <!-- SQL View -->
            <div id="view-sql" class="hidden">
                <div class="sql-console">
                    <h3 style="margin-top: 0; font-family: 'Cinzel', serif; color: #fff;">Execute SQL Query</h3>
                    <textarea id="sql-query" class="sql-input" placeholder="SELECT * FROM users WHERE..."></textarea>
                    <button class="btn-execute" onclick="executeSQL()">Run Query</button>
                </div>
                <div id="sql-results" class="table-container hidden"></div>
                <div id="schema-visual" class="table-container" style="margin-top:20px;">
                    <div class="loading">Loading schema...</div>
                </div>
            </div>
            <!-- About Section -->
            <div id="view-about" class="card hidden" style="padding:20px; margin-top:20px;">
                <h3 style="font-family:'Cinzel', serif; color:#3e2b1e;">About This Project</h3>
                <div class="about-section">
                    <p style="line-height:1.7; color:#5c4635; margin-top:0;">
                        <strong>Secure Online Confession Booth</strong> adalah proyek kriptografi Kelompok Welsa yang merancang platform pengakuan dosa daring dengan keamanan end-to-end. Sistem memastikan pesan antara peniten dan pastor terenkripsi sebelum meninggalkan browser, sementara server hanya menyimpan ciphertext dan metadata untuk audit. Selain modul chat, ada panel admin, visualisasi skema database, serta dashboard statistik untuk memantau kesehatan sistem.
                    </p>
                </div>
                <div class="about-section">
                    <h4>Kelompok Welsa</h4>
                    <ul class="makers-list">
                        <li>Arwindo Sendy Pratama (230712555)</li>
                        <li>Yonatan Adi Cahyoningrat (230712440)</li>
                        <li>Gracia Putri Aura (230712515)</li>
                        <li>Gretelia Faustine (230712322)</li>
                        <li>Velin Ceria Resminawati (230712478)</li>
                    </ul>
                </div>
                <div class="about-section">
                    <h4>Layanan Kriptografi</h4>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Layanan</th>
                                    <th>Algoritma</th>
                                    <th>Alasan</th>
                                    <th>Implementasi</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Otentikasi</td>
                                    <td>Bcrypt + PHP Session</td>
                                    <td>Hash adaptif mencegah brute-force; session menjaga state login.</td>
                                    <td><code>php/register.php</code> menyimpan <code>password_hash</code>, <code>php/login.php</code> memverifikasi dan menyetel session sebelum akses API.</td>
                                </tr>
                                <tr>
                                    <td>Kerahasiaan</td>
                                    <td>ECDH (P-256) + AES-256-CBC</td>
                                    <td>EChDH ringan untuk browser dan menghasilkan session key unik; AES-256 memiliki dukungan luas dan cepat.</td>
                                    <td><code>js/chat-crypto.js</code> melakukan derivasi shared secret dan enkripsi sebelum POST ke <code>php/api/chat/messages.php</code>.</td>
                                </tr>
                                <tr>
                                    <td>Integritas</td>
                                    <td>SHA-256 + kunci publik per pesan</td>
                                    <td>Perubahan ciphertext menyebabkan gagal decrypt; hash memastikan payload asli.</td>
                                    <td>Kolom <code>sender_public_key</code>/<code>recipient_public_key</code> di <code>chat_messages</code>; debug panel menandai kegagalan dekripsi.</td>
                                </tr>
                                <tr>
                                    <td>Anti-penyangkalan</td>
                                    <td>RSA Signature (legacy) & metadata ECDH</td>
                                    <td>Setiap pesan dapat ditelusur ke kunci publik terdaftar.</td>
                                    <td>Fungsi di <code>php/functions.php</code> menyimpan hash + signature untuk konfesi lama; chat baru mencatat fingerprint kunci di setiap pesan.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Encryption Viz View -->
            <div id="view-encryption" class="hidden">
                <div class="encryption-container">
                    <h3 style="font-family: 'Cinzel', serif; color: #3e2b1e; text-align: center; margin-bottom: 30px;">
                        Secure Chat Encryption (ECDH + AES)</h3>
                    <p class="viz-description">The chat module uses an Elliptic-Curve Diffie-Hellman (P-256) key
                        exchange to derive a shared secret for every conversation, then applies AES-256 to encrypt the
                        plaintext before it leaves the browser. Only ciphertext and key fingerprints reside on the
                        server.</p>

                    <div class="viz-stage-container">
                        <!-- Step 1: Client Input -->
                        <div class="viz-step" id="step-1">
                            <div class="viz-icon">üë§</div>
                            <div class="viz-label">User Input</div>
                            <div class="viz-box">"Forgive me..."</div>
                        </div>

                        <!-- Step 2: Public Key -->
                        <div class="viz-step" id="step-2">
                            <div class="viz-icon">üîë</div>
                            <div class="viz-label">Public Key</div>
                            <div class="viz-box" style="border-color: #8c3333;">(Encrypting)</div>
                        </div>

                        <!-- Step 3: Encrypted Data -->
                        <div class="viz-step" id="step-3">
                            <div class="viz-icon">üîí</div>
                            <div class="viz-label">Encrypted Data</div>
                            <div class="viz-box" style="background: #e0e0e0; color: #555; font-family: monospace;">
                                a8f9c2...</div>
                        </div>
                        <!-- Step 4: Server Storage -->
                        <div class="viz-step" id="step-4">
                            <div class="viz-icon">üíæ</div>
                            <div class="viz-label">Database</div>
                            <div class="viz-box">Stored Safely</div>
                        </div>
                    </div>

                    <!-- Moving Packet -->
                    <div id="viz-packet" class="viz-packet hidden">üìù</div>
                    <div class="viz-controls">
                        <div class="viz-field" style="grid-column: span 2; min-width: 260px;">
                            <label for="plaintext-input">Plaintext Message</label>
                            <textarea id="plaintext-input"
                                placeholder="Type the message that will be encrypted"></textarea>
                        </div>
                        <div class="viz-field">
                            <label>Public Key Snapshot</label>
                            <div id="public-key-display" class="viz-info-box">Generating key...</div>
                        </div>
                        <div class="viz-field">
                            <label>Ciphertext Output</label>
                            <div id="ciphertext-output" class="viz-info-box light">Encrypted blob will appear here.
                            </div>
                        </div>
                    </div>
                    <div class="viz-buttons">
                        <button class="primary" onclick="runEncryptionDemo()">Start / Restart</button>
                        <button onclick="pauseEncryptionDemo()">Pause</button>
                        <button onclick="resumeEncryptionDemo()">Resume</button>
                        <button onclick="resetEncryptionDemo()">Reset</button>
                        <div class="viz-speed">
                            <label for="speed-slider">Speed:</label>
                            <input id="speed-slider" type="range" min="1200" max="4000" step="200" value="2200"
                                oninput="handleSpeedChange(this.value)">
                            <span id="speed-label">2.2s per hop</span>
                        </div>
                    </div>
                    <div class="viz-info-grid">
                        <div class="viz-info-card">
                            <h4>Algorithm Summary</h4>
                            <p id="algorithm-info">Loading...</p>
                        </div>
                        <div class="viz-info-card">
                            <h4>Key Details</h4>
                            <ul id="key-meta">
                                <li>Length: -</li>
                                <li>Fingerprint: -</li>
                                <li>Last Rotation: -</li>
                            </ul>
                        </div>
                        <div class="viz-info-card">
                            <h4>Ciphertext Insights</h4>
                            <ul id="cipher-meta">
                                <li>Bytes: -</li>
                                <li>Preview: -</li>
                                <li>Checksum: -</li>
                            </ul>
                        </div>
                    </div>
                    <div class="viz-log" id="viz-log">Ready to simulate encryption.</div>
                </div>

                <div id="viz-status"
                    style="text-align: center; margin-top: 20px; font-style: italic; color: #8c7348; height: 20px;">
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="edit-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <button class="modal-close" onclick="closeEditModal()">&times;</button>
            <div class="modal-header">
                <h3 class="modal-title">Edit Record</h3>
            </div>
            <div class="modal-body">
                <div id="edit-form-container"></div>
                <div style="margin-top:20px; text-align:right;">
                    <button onclick="closeEditModal()"
                        style="padding:8px 20px; background:#ccc; border:none; cursor:pointer; margin-right:10px; font-family:'Cinzel', serif;">Cancel</button>
                    <button onclick="saveEdit()"
                        style="padding:8px 20px; background:#2e7d32; color:white; border:none; cursor:pointer; font-family:'Cinzel', serif;">Save
                        Changes</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'php/api/db_manager.php';
        const TABLE_LABELS = {
            users: 'Users',
            chat_threads: 'Chat Threads',
            chat_messages: 'Chat Messages',
            chat_keys: 'Chat Keys',
        };
        let currentTable = null;
        let cachedPublicKey = '';
        let vizTimeline = null;
        let animationDuration = 2200;
        let keyMeta = { curve: 'P-256', fingerprint: '', rotation: '' };
        let dashboardStats = null;

        function renderTableNav() {
            const container = document.getElementById('table-nav');
            if (!container) return;
            container.innerHTML = '';
            Object.entries(TABLE_LABELS).forEach(([table, label]) => {
                const item = document.createElement('div');
                item.className = 'nav-item';
                item.dataset.table = table;
                item.textContent = label;
                item.addEventListener('click', () => loadTable(table));
                container.appendChild(item);
            });
        }

        function randomHex(length) {
            let output = '';
            const chars = 'abcdef0123456789';
            for (let i = 0; i < length; i++) {
                output += chars[Math.floor(Math.random() * chars.length)];
            }
            return output;
        }

        function generatePublicKeySnippet() {
            const blocks = [];
            for (let i = 0; i < 6; i++) {
                blocks.push(randomHex(32));
            }
            return '-----BEGIN PUBLIC KEY-----\n' + blocks.join('\n') + '\n-----END PUBLIC KEY-----';
        }

        function fakeEncrypt(message) {
            if (!message) return '';
            const encoder = new TextEncoder();
            const bytes = encoder.encode(message);
            const hex = Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join('');
            return (hex + randomHex(64)).substring(0, 96) + '...';
        }

        function initializeEncryptionViz() {
            cachedPublicKey = generatePublicKeySnippet();
            const keyDisplay = document.getElementById('public-key-display');
            if (keyDisplay) keyDisplay.innerText = cachedPublicKey;
            const curves = ['P-256', 'P-384', 'Curve25519'];
            keyMeta.curve = curves[Math.floor(Math.random() * curves.length)];
            keyMeta.fingerprint = randomHex(12).toUpperCase();
            keyMeta.rotation = new Date().toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
            updateKeyMeta();
            updateAlgorithmInfo();
            const slider = document.getElementById('speed-slider');
            handleSpeedChange(slider ? slider.value : animationDuration);
            updateCipherMeta('');
            resetEncryptionDemo(true);
        }

        function logVizStep(message) {
            const log = document.getElementById('viz-log');
            if (!log) return;
            const entry = document.createElement('div');
            entry.innerHTML = `<strong>‚Ä¢</strong> ${message}`;
            log.appendChild(entry);
        }

        function updateKeyMeta() {
            const keyList = document.getElementById('key-meta');
            if (!keyList) return;
            keyList.innerHTML = `
                <li>Curve: ${keyMeta.curve} ECDH</li>
                <li>Fingerprint: ${keyMeta.fingerprint.slice(0, 4)}:${keyMeta.fingerprint.slice(4, 8)}:${keyMeta.fingerprint.slice(8)}</li>
                <li>Last Rotation: ${keyMeta.rotation}</li>`;
        }

        function updateCipherMeta(cipherText = '') {
            const cipherList = document.getElementById('cipher-meta');
            if (!cipherList) return;
            if (!cipherText) {
                cipherList.innerHTML = '<li>Bytes: -</li><li>Preview: -</li><li>Checksum: -</li>';
                return;
            }
            const hexOnly = cipherText.replace(/[^0-9a-f]/gi, '');
            const bytes = Math.ceil(hexOnly.length / 2);
            const preview = cipherText.substring(0, 16) + '...';
            const checksum = randomHex(8).toUpperCase();
            cipherList.innerHTML = `
                <li>Bytes: ~${bytes}</li>
                <li>Preview: ${preview}</li>
                <li>Checksum: ${checksum}</li>`;
        }

        function updateAlgorithmInfo() {
            const info = document.getElementById('algorithm-info');
            if (!info) return;
            info.innerText = 'Elliptic-Curve Diffie-Hellman (P-256) derives a shared secret per session. That secret becomes an AES-256 key that encrypts every chat message in-browser; only ciphertext and metadata hit the database.';
        }

        function handleSpeedChange(value) {
            animationDuration = Number(value);
            const label = document.getElementById('speed-label');
            if (label) {
                label.innerText = (animationDuration / 1000).toFixed(1) + 's per hop';
            }
        }

        function resetEncryptionDemo(clearCipher = true) {
            if (vizTimeline) {
                vizTimeline.pause();
                vizTimeline = null;
            }

            const packet = document.getElementById('viz-packet');
            if (packet) {
                packet.classList.add('hidden');
                packet.style.opacity = 1;
                packet.style.transform = 'scale(1)';
                packet.style.left = '0px';
                packet.style.top = '0px';
            }
            document.querySelectorAll('.viz-step').forEach(el => el.classList.remove('active-step'));
            const status = document.getElementById('viz-status');
            if (status) status.innerText = 'Awaiting input.';

            const log = document.getElementById('viz-log');
            if (log) log.innerHTML = 'Ready to simulate encryption.';

            if (clearCipher) {
                const cipherOutput = document.getElementById('ciphertext-output');
                if (cipherOutput) cipherOutput.innerText = 'Encrypted blob will appear here.';
                updateCipherMeta('');
            }
        }

        function pauseEncryptionDemo() {
            if (vizTimeline) vizTimeline.pause();
        }

        function resumeEncryptionDemo() {
            if (vizTimeline) vizTimeline.play();
        }

        // Check Auth on Load
        async function checkAuth() {
            try {
                const res = await fetch('php/api/session.php');
                const data = await res.json();
                if (!data.authenticated || data.role !== 'priest') {
                    document.body.classList.add('access-denied-body');
                    document.body.innerHTML = `
                        <div class="access-denied-wrapper">
                            <h2 style="font-family:Cinzel, serif; color:#8c3333; margin-bottom: 20px;">Admin Access Required</h2>
                            <p style="margin-bottom: 20px;">You must be logged in as a Priest to access this console.</p>
                            
                            <div style="background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 350px; border: 1px solid #d4c5b0;">
                                <form id="admin-login-form" onsubmit="handleAdminLogin(event)">
                                    <div style="margin-bottom: 15px; text-align: left;">
                                        <label style="display:block; font-family:'Cinzel', serif; font-size:12px; margin-bottom:5px; color:#5c4635;">Username</label>
                                        <input type="text" name="username" required style="width:100%; padding:10px; border:1px solid #d4c5b0; border-radius:4px; font-family:'PT Sans', sans-serif;">
                                    </div>
                                    <div style="margin-bottom: 20px; text-align: left;">
                                        <label style="display:block; font-family:'Cinzel', serif; font-size:12px; margin-bottom:5px; color:#5c4635;">Password</label>
                                        <input type="password" name="password" required style="width:100%; padding:10px; border:1px solid #d4c5b0; border-radius:4px; font-family:'PT Sans', sans-serif;">
                                    </div>
                                    <div id="login-msg" style="margin-bottom: 15px; font-size: 13px;"></div>
                                    <button type="submit" style="width:100%; padding:12px; background:#8c3333; color:white; border:none; border-radius:4px; font-family:'Cinzel', serif; cursor:pointer; font-weight:bold;">Login to Console</button>
                                </form>
                                
                                <div style="margin-top: 20px; border-top: 1px dashed #d4c5b0; padding-top: 15px;">
                                    <label style="display:block; font-family:'Cinzel', serif; font-size:12px; margin-bottom:5px; color:#5c4635;">Secret Code</label>
                                    <div style="display:flex; gap:5px;">
                                        <input type="password" id="secret-code-input" placeholder="Enter code..." style="flex:1; padding:8px; border:1px solid #d4c5b0; border-radius:4px; font-family:'PT Sans', sans-serif;">
                                        <button onclick="handleSecretCode()" style="padding:8px 12px; background:#5c4635; color:white; border:none; border-radius:4px; cursor:pointer;">&rarr;</button>
                                    </div>
                                </div>
                            </div>
                            
                            <a href="index.html" style="color:#8c7348; margin-top:20px; text-decoration:none; font-size:13px;">&larr; Return to Sanctuary</a>
                        </div>`;
                } else {
                    document.getElementById('user-info').innerText = `Logged in as: ${data.full_name} (${data.role})`;
                }
            } catch (e) {
                console.error(e);
            }
        }

        let adminSecret = '';

        function handleSecretCode() {
            const code = document.getElementById('secret-code-input').value;
            if (code === 'admin') {
                adminSecret = code;
                // Let's persist in sessionStorage
                sessionStorage.setItem('adminSecret', 'admin');
                window.location.reload();
            } else {
                alert('Invalid Code');
            }
        }

        // Check for secret in session storage on load
        if (sessionStorage.getItem('adminSecret') === 'admin') {
            adminSecret = 'admin';
        }

        async function handleAdminLogin(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const msg = document.getElementById('login-msg');
            const btn = form.querySelector('button');

            btn.disabled = true;
            btn.innerText = 'Verifying...';
            msg.innerHTML = '';

            try {
                const res = await fetch('php/login.php', {
                    method: 'POST',
                    body: formData
                });
                const json = await res.json();

                if (json.success) {
                    msg.innerHTML = '<span style="color:green">Access Granted. Reloading...</span>';
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    msg.innerHTML = `<span style="color:red">${json.message}</span>`;
                    btn.disabled = false;
                    btn.innerText = 'Login to Console';
                }
            } catch (err) {
                msg.innerHTML = '<span style="color:red">Connection Error</span>';
                btn.disabled = false;
                btn.innerText = 'Login to Console';
            }
        }

        // Modify checkAuth to respect adminSecret
        const originalCheckAuth = checkAuth;
        checkAuth = async function () {
            if (adminSecret === 'admin') {
                document.getElementById('user-info').innerText = 'Logged in via Secret Code';
                return;
            }
            await originalCheckAuth();
        };
        window.addEventListener('DOMContentLoaded', () => {
            renderTableNav();
            checkAuth();
            switchTab('dashboard');
            loadSchemaViz();
        });

        // Navigation
        function switchTab(tab) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));

            document.getElementById('view-dashboard').classList.add('hidden');
            document.getElementById('view-tables').classList.add('hidden');
            document.getElementById('view-sql').classList.add('hidden');
            document.getElementById('view-encryption').classList.add('hidden');
            document.getElementById('view-about').classList.add('hidden');

            if (tab === 'dashboard') {
                document.getElementById('view-dashboard').classList.remove('hidden');
                document.getElementById('page-title').innerText = 'Dashboard';
                document.querySelector('.nav-item[data-view="dashboard"]').classList.add('active');
                refreshDashboard();
                return;
            }

            if (tab === 'tables') {
                document.getElementById('view-tables').classList.remove('hidden');
                const label = currentTable ? (TABLE_LABELS[currentTable] || currentTable) : 'Tables';
                document.getElementById('page-title').innerText = currentTable ? `Table: ${label}` : 'Tables';
                if (currentTable) {
                    document.querySelectorAll('.nav-item[data-table]').forEach(item => {
                        if (item.dataset.table === currentTable) {
                            item.classList.add('active');
                        }
                    });
                }
            } else if (tab === 'sql') {
                document.getElementById('view-sql').classList.remove('hidden');
                document.getElementById('page-title').innerText = 'SQL Console';
                document.querySelector('.nav-item[onclick="switchTab(\'sql\')"]').classList.add('active');
            } else if (tab === 'encryption') {
                document.getElementById('view-encryption').classList.remove('hidden');
                document.getElementById('page-title').innerText = 'Encryption Visualization';
                document.querySelector('.nav-item[onclick="switchTab(\'encryption\')"]').classList.add('active');
            } else if (tab === 'about') {
                document.getElementById('view-about').classList.remove('hidden');
                document.getElementById('page-title').innerText = 'About';
                document.querySelector('.nav-item[onclick="switchTab(\'about\')"]').classList.add('active');
            }
        }

        // Load Table Data
        async function loadTable(tableName) {
            currentTable = tableName;
            switchTab('tables');
            const tableLabel = TABLE_LABELS[tableName] || tableName;
            document.getElementById('page-title').innerText = `Table: ${tableLabel}`;

            // Update sidebar active state
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item[data-table]').forEach(item => {
                if (item.dataset.table === tableName) {
                    item.classList.add('active');
                }
            });

            const wrapper = document.getElementById('data-table-wrapper');
            wrapper.innerHTML = '<div class="loading">Loading data...</div>';

            try {
                const formData = new FormData();
                formData.append('action', 'fetch_data');
                formData.append('table', tableName);
                if (adminSecret) formData.append('secret_code', adminSecret);

                const res = await fetch(API_URL, { method: 'POST', body: formData });
                const json = await res.json();

                if (json.success) {
                    renderTable(json.data, wrapper, true);
                } else {
                    wrapper.innerHTML = `<div class="error-msg">${json.message}</div>`;
                }
            } catch (e) {
                wrapper.innerHTML = `<div class="error-msg">Connection error: ${e.message}</div>`;
            }
        }

        // Render Table
        function renderTable(data, container, allowDelete = false) {
            if (!data || data.length === 0) {
                container.innerHTML = '<div style="padding:20px; text-align:center; color:#888;">No records found.</div>';
                return;
            }

            const columns = Object.keys(data[0]);
            let html = '<table><thead><tr>';

            columns.forEach(col => {
                html += `<th>${col}</th>`;
            });
            if (allowDelete) html += '<th>Actions</th>';

            html += '</tr></thead><tbody>';

            data.forEach(row => {
                html += '<tr>';
                columns.forEach(col => {
                    let val = row[col];
                    // Truncate long text
                    if (val && val.length > 50) val = val.substring(0, 50) + '...';
                    html += `<td>${val !== null ? val : '<em style="color:#ccc">NULL</em>'}</td>`;
                });

                if (allowDelete) {
                    html += `<td>
                        <button class="action-btn" style="background:#1976d2; color:white; margin-right:5px;" onclick='openEditModal(${JSON.stringify(row)})'>Edit</button>
                        <button class="action-btn btn-delete" onclick="deleteRow(${row.id})">Delete</button>
                    </td>`;
                }
                html += '</tr>';
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Delete Row
        async function deleteRow(id) {
            if (!confirm('Are you sure you want to delete this record? This cannot be undone.')) return;

            try {
                const formData = new FormData();
                formData.append('action', 'delete_row');
                formData.append('table', currentTable);
                formData.append('id', id);
                if (adminSecret) formData.append('secret_code', adminSecret);

                const res = await fetch(API_URL, { method: 'POST', body: formData });
                const json = await res.json();

                if (json.success) {
                    showMessage('Record deleted successfully.', 'success');
                    loadTable(currentTable); // Reload
                } else {
                    showMessage(json.message, 'error');
                }
            } catch (e) {
                showMessage('Connection error.', 'error');
            }
        }

        // Execute SQL
        async function executeSQL() {
            const query = document.getElementById('sql-query').value.trim();
            if (!query) return;

            const resultsContainer = document.getElementById('sql-results');
            resultsContainer.classList.remove('hidden');
            resultsContainer.innerHTML = '<div class="loading">Executing...</div>';

            try {
                const formData = new FormData();
                formData.append('action', 'execute_sql');
                formData.append('query', query);
                if (adminSecret) formData.append('secret_code', adminSecret);

                const res = await fetch(API_URL, { method: 'POST', body: formData });
                const json = await res.json();

                if (json.success) {
                    if (json.data) {
                        renderTable(json.data, resultsContainer, false);
                    } else {
                        resultsContainer.innerHTML = `<div class="success-msg">${json.message}</div>`;
                    }
                } else {
                    resultsContainer.innerHTML = `<div class="error-msg">${json.message}</div>`;
                }
            } catch (e) {
                resultsContainer.innerHTML = `<div class="error-msg">Connection error: ${e.message}</div>`;
            }
        }

        async function loadSchemaViz() {
            const container = document.getElementById('schema-visual');
            if (!container) return;
            container.innerHTML = '<div class="loading">Loading schema...</div>';

            try {
                const formData = new FormData();
                formData.append('action', 'fetch_schema');
                if (adminSecret) formData.append('secret_code', adminSecret);

                const res = await fetch(API_URL, { method: 'POST', body: formData });
                const json = await res.json();

                if (!json.success || !Array.isArray(json.tables)) {
                    container.innerHTML = '<div class="error-msg">Unable to load schema overview.</div>';
                    return;
                }

                let html = '<table><thead><tr><th>Table</th><th>Columns</th></tr></thead><tbody>';
                json.tables.forEach(table => {
                    const cols = table.columns.map(col => `<strong>${col.name}</strong> <span style="color:#8c7348;">(${col.type})</span>${col.key ? ' üîë' : ''}`).join('<br>');
                    html += `<tr><td>${table.name}</td><td>${cols}</td></tr>`;
                });
                html += '</tbody></table>';
                container.innerHTML = html;
            } catch (err) {
                container.innerHTML = `<div class="error-msg">Schema load failed: ${err.message}</div>`;
            }
        }

        function showMessage(msg, type) {
            const el = document.getElementById('message-area');
            el.innerHTML = `<div class="${type === 'success' ? 'success-msg' : 'error-msg'}">${msg}</div>`;
            setTimeout(() => el.innerHTML = '', 3000);
        }

        // Edit Modal Logic
        let currentEditId = null;

        function openEditModal(row) {
            currentEditId = row.id;
            const container = document.getElementById('edit-form-container');
            let html = '';

            for (const [key, value] of Object.entries(row)) {
                if (key === 'id') continue; // Don't edit ID

                // Check if value is long text
                const isLong = value && value.length > 100;

                html += `<div style="margin-bottom:15px;">
                    <label style="display:block; font-weight:bold; margin-bottom:5px; font-size:12px; font-family:'Cinzel', serif; color:#5e4533;">${key}</label>`;

                if (isLong) {
                    html += `<textarea id="edit-${key}" style="width:100%; padding:8px; border:1px solid #d4c5b0; height:100px; font-family:'PT Sans', sans-serif;">${value || ''}</textarea>`;
                } else {
                    html += `<input type="text" id="edit-${key}" value="${value !== null ? value.replace(/"/g, '&quot;') : ''}" style="width:100%; padding:8px; border:1px solid #d4c5b0; font-family:'PT Sans', sans-serif;">`;
                }

                html += `</div>`;
            }

            container.innerHTML = html;
            document.getElementById('edit-modal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('edit-modal').classList.remove('active');
            currentEditId = null;
        }

        async function saveEdit() {
            if (!currentEditId) return;

            const inputs = document.querySelectorAll('#edit-form-container input, #edit-form-container textarea');
            const updates = {};

            inputs.forEach(input => {
                const key = input.id.replace('edit-', '');
                updates[key] = input.value;
            });

            try {
                const formData = new FormData();
                formData.append('action', 'update_row');
                formData.append('table', currentTable);
                formData.append('id', currentEditId);
                formData.append('data', JSON.stringify(updates));
                if (adminSecret) formData.append('secret_code', adminSecret);

                const res = await fetch(API_URL, { method: 'POST', body: formData });
                const json = await res.json();

                if (json.success) {
                    showMessage('Record updated successfully.', 'success');
                    closeEditModal();
                    loadTable(currentTable);
                } else {
                    alert('Error: ' + json.message);
                }
            } catch (e) {
                alert('Connection error: ' + e.message);
            }
        }

        // Encryption Demo Logic (Anime.js)
        function runEncryptionDemo() {
            resetEncryptionDemo(false);

            const packet = document.getElementById('viz-packet');
            const status = document.getElementById('viz-status');
            const input = document.getElementById('plaintext-input');
            const cipherOutput = document.getElementById('ciphertext-output');
            const log = document.getElementById('viz-log');
            const message = (input && input.value.trim()) || 'Forgive me father, for I have sinned.';

            if (log) {
                log.innerHTML = '';
                logVizStep('Message captured from the secure composer.');
            }

            const plaintextBox = document.querySelector('#step-1 .viz-box');
            if (plaintextBox) plaintextBox.innerText = message;

            if (!cachedPublicKey) {
                initializeEncryptionViz();
            }

            const cipherText = fakeEncrypt(message + cachedPublicKey + Date.now());
            if (cipherOutput) cipherOutput.innerText = cipherText;
            updateCipherMeta(cipherText);
            logVizStep('Browser derives shared secret via ECDH and encrypts with AES-256 before sending.');

            function getCenter(id) {
                const el = document.getElementById(id);
                const host = document.querySelector('.encryption-container');
                if (!el || !host || !packet) {
                    return { x: 0, y: 0 };
                }
                const elRect = el.getBoundingClientRect();
                const hostRect = host.getBoundingClientRect();
                const packetSize = packet.offsetWidth || 40;
                return {
                    x: elRect.left - hostRect.left + (elRect.width - packetSize) / 2,
                    y: elRect.top - hostRect.top + (elRect.height - packetSize) / 2
                };
            }

            if (!packet || !status) return;

            // Reset State
            packet.classList.remove('hidden');
            const startPos = getCenter('step-1');
            packet.style.left = startPos.x + 'px';
            packet.style.top = startPos.y + 'px';
            packet.innerText = 'üìù';
            packet.style.backgroundColor = '#fff';
            packet.style.color = '#000';
            packet.style.borderColor = '#8c3333';

            document.querySelectorAll('.viz-step').forEach(el => el.classList.remove('active-step'));
            document.getElementById('step-1').classList.add('active-step');
            status.innerText = 'User composes message...';
            logVizStep('Payload prepared. Ready to send encrypted blob.');

            // Create Timeline
            vizTimeline = anime.timeline({
                easing: 'easeInOutQuad',
                duration: animationDuration
            });

            // Step 1 -> Step 2
            const pos2 = getCenter('step-2');
            vizTimeline.add({
                targets: packet,
                left: pos2.x,
                top: pos2.y,
                changeBegin: () => {
                    document.querySelectorAll('.viz-step').forEach(el => el.classList.remove('active-step'));
                    document.getElementById('step-2').classList.add('active-step');
                    status.innerText = 'Client retrieves partner public key...';
                    logVizStep('Fetching cached ECDH public key from register_key endpoint.');
                }
            })
                // Step 2 -> Step 3 (Encryption happens)
                .add({
                    targets: packet,
                    left: getCenter('step-3').x,
                    top: getCenter('step-3').y,
                    backgroundColor: '#2b1d12', // Darken
                    color: '#e6d2a0',
                    borderColor: '#5c4635',
                    rotate: '1turn', // Spin effect
                    changeBegin: () => {
                        document.querySelectorAll('.viz-step').forEach(el => el.classList.remove('active-step'));
                        document.getElementById('step-3').classList.add('active-step');
                        status.innerText = 'Shared secret derived, AES key ready...';
                        packet.innerText = 'üîí';
                        logVizStep('Plaintext transformed into ciphertext: ' + cipherText.substring(0, 24) + '...');
                    }
                })
                // Step 3 -> Step 4 (Storage)
                .add({
                    targets: packet,
                    left: getCenter('step-4').x,
                    top: getCenter('step-4').y,
                    scale: 0.5, // Shrink into DB
                    opacity: 0, // Fade out
                    changeBegin: () => {
                        document.querySelectorAll('.viz-step').forEach(el => el.classList.remove('active-step'));
                        document.getElementById('step-4').classList.add('active-step');
                        status.innerText = 'Encrypted blob stored in database.';
                        logVizStep('Server only stores ciphertext chunk referencing chat metadata.');
                    },
                    complete: () => {
                        status.innerText = 'Process complete. Secure.';
                        setTimeout(() => {
                            packet.style.opacity = 1;
                            packet.style.transform = 'scale(1)';
                            packet.classList.add('hidden');
                        }, 500);
                        logVizStep('Audit trail updated. Ready for decryption on priest console.');
                    }
                });
        }

        function updateStep(index, steps, packet) {
            // Legacy function kept just in case, but unused now.
        }

        document.addEventListener('DOMContentLoaded', () => {
            initializeEncryptionViz();
        });
        async function refreshDashboard() {
            try {
                const formData = new FormData();
                formData.append('action', 'fetch_data');
                if (adminSecret) formData.append('secret_code', adminSecret);

                const tables = {};
                const fetchTable = async (table) => {
                    formData.set('table', table);
                    const res = await fetch(API_URL, { method: 'POST', body: formData });
                    const json = await res.json();
                    return json.success && Array.isArray(json.data) ? json.data : [];
                };

                tables.users = await fetchTable('users');
                tables.chat_threads = await fetchTable('chat_threads');
                tables.chat_messages = await fetchTable('chat_messages');
                tables.chat_keys = await fetchTable('chat_keys');

                const priests = tables.users.filter(u => u.role === 'priest');
                const penitents = tables.users.filter(u => u.role === 'user');
                const openThreads = tables.chat_threads.filter(t => Number(t.resolved) === 0);
                const closedThreads = tables.chat_threads.length - openThreads.length;
                const messages24h = tables.chat_messages.filter(m => {
                    const ts = new Date(m.created_at + 'Z');
                    return (Date.now() - ts.getTime()) <= 24 * 3600 * 1000;
                });

                document.getElementById('dash-users').innerText = tables.users.length;
                document.getElementById('dash-priests').innerText = priests.length;
                document.getElementById('dash-penitents').innerText = penitents.length;

                document.getElementById('dash-threads').innerText = tables.chat_threads.length;
                document.getElementById('dash-open-threads').innerText = openThreads.length;
                document.getElementById('dash-closed-threads').innerText = closedThreads;

                document.getElementById('dash-messages').innerText = tables.chat_messages.length;
                document.getElementById('dash-messages-24h').innerText = messages24h.length;

                document.getElementById('dash-keys').innerText = tables.chat_keys.length;
                const keyUserIds = new Set(tables.chat_keys.map(key => Number(key.user_id)));
                const missingKeys = tables.users.filter(u => !keyUserIds.has(Number(u.id))).length;
                document.getElementById('dash-key-gaps').innerText = missingKeys;

                const threadCounts = tables.chat_messages.reduce((acc, msg) => {
                    acc[msg.thread_id] = (acc[msg.thread_id] || 0) + 1;
                    return acc;
                }, {});
                const avgMessages = tables.chat_threads.length
                    ? (Object.values(threadCounts).reduce((a, b) => a + b, 0) / tables.chat_threads.length).toFixed(1)
                    : '0';
                document.getElementById('dash-avg-thread').innerText = avgMessages;

                const latestThread = tables.chat_threads
                    .sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at))[0];
                if (latestThread) {
                    const partner = tables.users.find(u => Number(u.id) === Number(latestThread.penitent_id));
                    document.getElementById('dash-latest-thread').innerText =
                        `${latestThread.subject} (${partner?.full_name || 'Unknown'})`;
                } else {
                    document.getElementById('dash-latest-thread').innerText = 'No threads yet.';
                }

                const priestActivity = {};
                const penitentActivity = {};
                tables.chat_messages.forEach((msg) => {
                    const sender = tables.users.find(u => Number(u.id) === Number(msg.sender_id));
                    if (!sender) return;
                    if (sender.role === 'priest') {
                        priestActivity[sender.full_name] = (priestActivity[sender.full_name] || 0) + 1;
                    } else {
                        penitentActivity[sender.full_name] = (penitentActivity[sender.full_name] || 0) + 1;
                    }
                });

                document.getElementById('dash-top-priest').innerText =
                    Object.keys(priestActivity).length
                        ? Object.entries(priestActivity).sort((a, b) => b[1] - a[1])[0].join(' ‚Äî ')
                        : 'No activity yet.';

                document.getElementById('dash-top-penitent').innerText =
                    Object.keys(penitentActivity).length
                        ? Object.entries(penitentActivity).sort((a, b) => b[1] - a[1])[0].join(' ‚Äî ')
                        : 'No activity yet.';

                await loadEnvironmentInfo();
            } catch (err) {
                console.error('Dashboard load failed', err);
            }
        }

        async function loadEnvironmentInfo() {
            try {
                const res = await fetch('php/api/env.php');
                const json = await res.json();
                if (json.success && json.env) {
                    document.getElementById('env-php').innerText = json.env.php || 'Unknown';
                    document.getElementById('env-mysql').innerText = json.env.mysql || 'Unknown';
                    document.getElementById('env-server').innerText = json.env.server || 'Unknown';
                    document.getElementById('env-xampp').innerText = json.env.xampp || 'Manual';
                    return;
                }
            } catch (err) {
                console.error('Env probe failed', err);
            }
            document.getElementById('env-php').innerText = 'Unavailable';
            document.getElementById('env-mysql').innerText = 'Unavailable';
            document.getElementById('env-server').innerText = 'Unavailable';
            document.getElementById('env-xampp').innerText = 'Manual';
        }

        async function runTest(kind) {
            const output = document.getElementById('test-output');
            if (!output) return;

            const labels = {
                workflow: 'Workflow Smoke',
                db: 'Database Check',
                integrity: 'Integrity Probe'
            };
            const label = labels[kind] || kind;
            output.innerText = `Running ${label}...`;

            try {
                const formData = new FormData();
                formData.append('action', 'run_test');
                formData.append('test', kind);
                if (adminSecret) {
                    formData.append('secret_code', adminSecret);
                }

                const res = await fetch(API_URL, { method: 'POST', body: formData });
                const json = await res.json();

                if (!json.success) {
                    throw new Error(json.message || 'Unknown error');
                }

                const timestamp = new Date().toLocaleString();
                const rawOutput = (json.output || '').trim() || 'No output (script returned empty).';
                output.innerText = `[${timestamp}] ${label} result:\n${rawOutput}`;
            } catch (err) {
                output.innerText = `Test failed: ${err.message}`;
            }
        }
</script>
</body>

</html>
