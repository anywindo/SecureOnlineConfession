<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>üîê Hybrid Encryption Chat</title>
    <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/elliptic/6.5.4/elliptic.min.js"></script>
    <link rel="stylesheet" href="./style/stylekoe.css">
</head>
<body>
<div class="container">
    <h1>üîê Hybrid Encryption Chat</h1>
    <h1>(ECDH + AES)</h1>
    <hr>

    <input id="username" placeholder="Nama Anda" />
    <button type="button" onclick="daftar()">Daftar (ganti kunci ECDH)</button>

    <input id="recipient" placeholder="Kirim ke (nama penerima)" />
    <textarea id="message" placeholder="Tulis pesan..."></textarea>
    <hr>

    <button type="button" onclick="kirimPesan()">Kirim Pesan</button>
    <button type="button" onclick="lihatPesan()">Lihat Pesan Masuk</button>
    <pre id="chat-box"></pre>
</div>

<script>
    const ec = new elliptic.ec("p256");

    function getRandomBytes(length) {
        const array = new Uint8Array(length);
        if (window.crypto && window.crypto.getRandomValues) {
            window.crypto.getRandomValues(array);
        } else {
            const wordArray = CryptoJS.lib.WordArray.random(length);
            for (let i = 0; i < length; i++) {
                array[i] = wordArray.words[i >>> 2] >>> (24 - (i % 4) * 8) & 0xff;
            }
        }
        return array;
    }

    function bytesToHex(bytes) {
        return Array.from(bytes).map(b => b.toString(16).padStart(2, "0")).join("");
    }

    function deriveAesKeyFromHex(sharedHex) {
        if (sharedHex.length % 2) sharedHex = "0" + sharedHex;
        return CryptoJS.SHA256(CryptoJS.enc.Hex.parse(sharedHex));
    }

    // üîë Registrasi dan buat pasangan kunci
    async function daftar() {
        const nama = document.getElementById("username").value.trim();
        if (!nama) return alert("Masukkan nama Anda dulu!");

        try {
            const entropyHex = bytesToHex(getRandomBytes(32));
            const keyPair = ec.genKeyPair({ entropy: entropyHex, entropyEnc: "hex" });
            const publicHex = keyPair.getPublic(false, "hex");
            const privateHex = keyPair.getPrivate("hex");

            sessionStorage.setItem("ecdh_private", privateHex);
            sessionStorage.setItem("ecdh_public", publicHex);

            await fetch("../backend/register.php", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ username: nama, public_key: publicHex })
            });

            alert("‚úÖ Registrasi berhasil!");
        } catch (err) {
            console.error(err);
            alert("‚ùå Gagal registrasi.");
        }
    }

    // ‚úâÔ∏è Kirim pesan terenkripsi (Hybrid ECDH + AES)
    async function kirimPesan() {
        const pengirim = document.getElementById("username").value.trim();
        const penerima = document.getElementById("recipient").value.trim();
        const teks = document.getElementById("message").value.trim();
        const publicKeyHex = sessionStorage.getItem("ecdh_public");
        const privateHex = sessionStorage.getItem("ecdh_private");

        if (!pengirim || !penerima || !teks) return alert("Isi semua kolom.");
        if (!privateHex || !publicKeyHex) return alert("Silakan daftar untuk membuat kunci ECDH.");

        const r = await fetch(`../backend/ambil_public_key.php?username=${encodeURIComponent(penerima)}`);
        const data = await r.json();
        if (data.error) return alert("‚ö†Ô∏è Terjadi error: " + data.error);
        if (!data.public_key) return alert("Public key penerima tidak ditemukan.");

        const privateKey = ec.keyFromPrivate(privateHex, "hex");
        const recipientPublic = ec.keyFromPublic(data.public_key, "hex");
        const sharedSecretHex = privateKey.derive(recipientPublic.getPublic()).toString(16);
        const aesKey = deriveAesKeyFromHex(sharedSecretHex);

        // Enkripsi pesan dengan session key AES dan IV
        const iv = CryptoJS.lib.WordArray.random(16);
        const encrypted = CryptoJS.AES.encrypt(teks, aesKey, { iv });
        const cipherText = iv.concat(encrypted.ciphertext).toString(CryptoJS.enc.Base64);

        const payload = {
            asal: pengirim,
            tujuan: penerima,
            kunci: publicKeyHex,
            pesan: cipherText
        };

        await fetch("../backend/simpan_pesan.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        const now = new Date();
        const chatBox = document.getElementById("chat-box");
        chatBox.textContent += `[${now.toLocaleString('id-ID', { hour12: false })}] Aku ke ${penerima}: ${teks}\n`;
        chatBox.scrollTop = chatBox.scrollHeight;
        document.getElementById("message").value = "";
    }

    // üì• Lihat & dekripsi pesan masuk
    async function lihatPesan() {
        const nama = document.getElementById("username").value.trim();
        const privateHex = sessionStorage.getItem("ecdh_private");
        if (!nama) return alert("Masukkan nama Anda dulu!");
        if (!privateHex) return alert("Private key tidak ada. Silakan daftar ulang.");

        const privateKey = ec.keyFromPrivate(privateHex, "hex");

        const r = await fetch(`../backend/baca_pesan.php?username=${encodeURIComponent(nama)}`);
        const pesanMasuk = await r.json();

        let hasil = "";
        for (const p of pesanMasuk) {
            try {
                if (!p.kunci) throw new Error("Kunci publik pengirim tidak ada");
                const senderPublic = ec.keyFromPublic(p.kunci, "hex");
                const sharedSecretHex = privateKey.derive(senderPublic.getPublic()).toString(16);
                const aesKey = deriveAesKeyFromHex(sharedSecretHex);

                // Pisahkan IV dan ciphertext
                const data = CryptoJS.enc.Base64.parse(p.pesan);
                const iv = CryptoJS.lib.WordArray.create(data.words.slice(0, 4), 16);
                const cipherText = CryptoJS.lib.WordArray.create(data.words.slice(4), data.sigBytes - 16);

                // Dekripsi pesan AES
                const decrypted = CryptoJS.AES.decrypt({ ciphertext: cipherText }, aesKey, { iv });
                const plainText = decrypted.toString(CryptoJS.enc.Utf8);

                if (!plainText) throw new Error("Plaintext kosong");
                hasil += `[${p.timestamp}] Dari ${p.asal}: ${plainText}\n`;
            } catch (e) {
                hasil += `[${p.timestamp}] ‚ö†Ô∏è Gagal mendekripsi pesan: ${e.message}\n`;
            }
        }

        const chatBox = document.getElementById("chat-box");
        chatBox.textContent += hasil || "Belum ada pesan.\n";
        chatBox.scrollTop = chatBox.scrollHeight;
    }
</script>
</body>
</html>
